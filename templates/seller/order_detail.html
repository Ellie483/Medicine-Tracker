{% extends "base.html" %}
{% block title %}Order · Pharmacy{% endblock %}

{% macro status_chip(s) -%}
  {% set s = (s or 'pending')|lower %}
  {% if s == 'delivered' %}
    <span class="badge rounded-pill bg-success"><i class="fas fa-box-open me-1"></i>Delivered</span>
  {% elif s == 'confirmed' %}
    <span class="badge rounded-pill bg-primary"><i class="fas fa-check me-1"></i>Confirmed</span>
  {% elif s == 'pending' %}
    <span class="badge rounded-pill bg-warning text-dark"><i class="fas fa-clock me-1"></i>Pending</span>
  {% elif s == 'cart' %}
    <span class="badge rounded-pill bg-secondary"><i class="fas fa-shopping-basket me-1"></i>Cart</span>
  {% else %}
    <span class="badge rounded-pill bg-light text-dark">{{ s|title }}</span>
  {% endif %}
{%- endmacro %}

{% macro payment_chip(s) -%}
  {% set s = (s or 'unpaid')|lower %}
  {% if s == 'paid' %}
    <span class="badge rounded-pill bg-success"><i class="fas fa-check me-1"></i>Paid</span>
  {% elif s == 'proof_uploaded' %}
    <span class="badge rounded-pill bg-info text-dark"><i class="fas fa-hourglass-half me-1"></i>Under Review</span>
  {% elif s == 'rejected' %}
    <span class="badge rounded-pill bg-danger"><i class="fas fa-times me-1"></i>Rejected</span>
  {% else %}
    <span class="badge rounded-pill bg-warning text-dark"><i class="fas fa-credit-card me-1"></i>Unpaid</span>
  {% endif %}
{%- endmacro %}

{% block content %}
<div class="container-xxl py-3">
  <a href="/seller/orders" class="btn btn-outline-secondary btn-sm mb-4">
    <i class="fas fa-arrow-left me-1"></i>Back to Orders
  </a>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h5 mb-0"><i class="fas fa-file-invoice me-2 text-primary"></i>Order #{{ order._id }}</h2>
    <div class="d-flex gap-2">
      <a href="/seller/orders/review" class="btn btn-outline-secondary btn-sm"><i class="fas fa-list-check me-1"></i>Review Queue</a>
      <a href="/seller/orders" class="btn btn-outline-secondary btn-sm"><i class="fas fa-rectangle-list me-1"></i>All Orders</a>
    </div>
  </div>

  <div class="row g-4 align-items-stretch">
    <!-- Order card (left) -->
    <div class="col-lg-8 d-flex">
      <div class="card border-0 shadow-sm h-100 w-100">
        <div class="card-body d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="text-muted small"><i class="fas fa-calendar me-1"></i>{{ order.created_at_str or order.created_at or '—' }}</div>
            <div class="d-flex flex-wrap gap-2">
              {{ status_chip(order.order_status) }}
              {{ payment_chip(order.payment_status) }}
            </div>
          </div>

          <h4 class="h6 mb-2"><i class="fas fa-user me-2 text-primary"></i>Buyer</h4>
          <div class="mb-1">
            <span class="fw-semibold">{{ order.buyer.display or '—' }}</span>
            {% if order.buyer.phone %}<span class="text-muted small ms-2"><i class="fas fa-phone me-1"></i>{{ order.buyer.phone }}</span>{% endif %}
            {% if order.buyer.email %}<span class="text-muted small ms-2"><i class="fas fa-envelope me-1"></i>{{ order.buyer.email }}</span>{% endif %}
          </div>
          {% if order.ship_to.address or order.ship_to.city %}
            <div class="text-muted small"><i class="fas fa-location-dot me-1"></i>{{ order.ship_to.address or '—' }}{% if order.ship_to.city %}, {{ order.ship_to.city }}{% endif %}</div>
          {% endif %}

          <hr>
          <h4 class="h6 mb-2"><i class="fas fa-pills me-2 text-primary"></i>Items</h4>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
                <tr><th>Medicine</th><th class="text-center">Qty</th><th class="text-end">Price</th><th class="text-end">Total</th></tr>
              </thead>
              <tbody>
                {% for it in order.get('items', []) %}
                  <tr>
                    <td class="break-any">{{ it['medicine_name'] }}</td>
                    <td class="text-center">{{ it['quantity'] }}</td>
                    <td class="text-end">{{ '%.2f'|format(it['price'] or 0) }}Ks</td>
                    <td class="text-end">{{ '%.2f'|format((it['quantity'] or 0) * (it['price'] or 0)) }}Ks</td>
                  </tr>
                {% else %}
                  <tr><td colspan="4" class="text-center text-muted">No items</td></tr>
                {% endfor %}
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <th colspan="3" class="text-end">Order Total</th>
                  <th class="text-end">{{ order.formatted_total }}</th>
                </tr>
                <tr>
                  <th colspan="3" class="text-end">Your Revenue</th>
                  <th class="text-end">{{ order.formatted_revenue_total }}</th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment + Actions (right) -->
    <div class="col-lg-4 d-flex">
      <div id="actions" class="card border-0 shadow-sm h-100 w-100">
        <div class="card-body d-flex flex-column">
          <!-- Payment header -->
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="h6 mb-0"><i class="fas fa-money-check-alt me-2"></i>Payment</h4>
            {{ payment_chip(order.payment_status) }}
          </div>
          <div class="small text-muted mb-2">
            {% if order.payment.uploaded_at %}Uploaded: <strong>{{ order.payment.uploaded_at }}</strong>{% endif %}
            {% if order.payment.payment_id %}<span class="ms-2">ID: <code>{{ order.payment.payment_id }}</code></span>{% endif %}
          </div>

          <!-- Links to proof/voucher -->
          <div class="d-grid gap-2 mb-3">
            {% if order.payment and order.payment.receipt_path %}
              <a href="{{ order.payment.receipt_path }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-file-image me-1"></i> View Buyer Proof
              </a>
            {% endif %}
            {% if order.payment and order.payment.seller_receipt_path %}
              <a href="{{ order.payment.seller_receipt_path }}" target="_blank" class="btn btn-outline-success btn-sm">
                <i class="fas fa-file-invoice me-1"></i> View Voucher
              </a>
            {% endif %}
          </div>

          {% if order.payment_status == 'rejected' and order.payment.rejected_reason %}
            <div class="alert alert-light border py-2 px-3 mb-3 small">
              <i class="fas fa-circle-xmark text-danger me-1"></i>
              Rejected: <span class="text-danger">{{ order.payment.rejected_reason }}</span>
            </div>
          {% endif %}

          <!-- Actions -->
          {# Payment header remains as you have it ... #}

<h4 class="h6 mt-1 mb-2"><i class="fas fa-wrench me-2"></i>Actions</h4>

{# --- Confirm Payment (unchanged) --- #}
{% if order.payment_status == 'paid' %}
  <div class="d-flex justify-content-between align-items-center action-row">
    <div class="d-flex align-items-center gap-2">
      <i class="fas fa-circle-check text-success"></i>
      <span class="fw-semibold">Confirm Payment</span>
    </div>
    <span class="badge bg-success d-inline-flex align-items-center">
      <i class="fas fa-check me-1"></i> Confirmed
    </span>
  </div>
{% elif order.payment_status == 'proof_uploaded' %}
  <form action="/seller/orders/{{ order._id }}/verify" method="post" class="d-grid gap-2 mb-2">
    <button class="btn btn-success"><i class="fas fa-check me-1"></i>Confirm Payment</button>
  </form>
  <form action="/seller/orders/{{ order._id }}/reject" method="post" class="d-grid gap-2">
    <div class="input-group input-group-sm">
      <span class="input-group-text"><i class="fas fa-comment-alt"></i></span>
      <input name="reason" class="form-control" placeholder="Reason for rejection" required>
    </div>
    <button class="btn btn-danger"><i class="fas fa-xmark me-1"></i>Reject Proof</button>
  </form>
{% endif %}

{# --- Voucher row (Generate → Send → Sent ✅) --- #}
{% set v = order.actions.voucher %}
{% if order.payment_status == 'paid' %}
  {% if not v.generated %}
    <form action="/seller/orders/{{ order._id }}/generate_receipt" method="post" class="d-grid mt-3">
      <button class="btn btn-outline-primary">
        <i class="fas fa-file-invoice me-1"></i> Generate Voucher
      </button>
    </form>
  {% elif v.generated and not v.sent %}
  {# --- Voucher generated row --- #}
  <div class="d-flex justify-content-between align-items-center action-row">
    <div class="d-flex align-items-center gap-2">
      <i class="fas fa-file-invoice text-primary"></i>
      <span class="fw-semibold">Voucher Generated</span>
    </div>
  
    {% if order.payment and order.payment.seller_receipt_path %}
      <a
        href="{{ order.payment.seller_receipt_path }}"
        class="btn btn-outline-secondary btn-sm"
        target="_blank"
        download
      >
        <i class="fas fa-download me-1"></i>Download
      </a>
    {% else %}
      <button class="btn btn-outline-secondary btn-sm" disabled>
        <i class="fas fa-download me-1"></i>Download
      </button>
    {% endif %}
  </div>
    <form action="/seller/orders/{{ order._id }}/send_receipt" method="post" class="d-grid mt-2">
      <button class="btn btn-primary">
        <i class="fas fa-paper-plane me-1"></i> Send Voucher to Buyer
      </button>
    </form>
  {% else %}
    <div class="d-flex justify-content-between align-items-center action-row mt-2">
      <div class="d-flex align-items-center gap-2">
        <i class="fas fa-paper-plane text-success"></i>
        <span class="fw-semibold">Voucher Sent</span>
      </div>
      <span class="badge bg-success d-inline-flex align-items-center">
        <i class="fas fa-check me-1"></i> Sent
      </span>
    </div>
    {% if order.payment.seller_receipt_sent_at %}
      <div class="small text-muted ms-4">Sent at: {{ order.payment.seller_receipt_sent_at }}</div>
    {% endif %}
  {% endif %}
{% endif %}

{# --- Delivered row (LOCKED until voucher sent) --- #}
<div class="d-flex justify-content-between align-items-center action-row mt-3">
  <div class="d-flex align-items-center gap-2">
    <i class="fas fa-box-open {% if order.actions.delivered.done %}text-success{% else %}text-muted{% endif %}"></i>
    <span class="fw-semibold">Delivered</span>
  </div>

  {% if order.actions.delivered.done %}
    <span class="badge bg-success d-inline-flex align-items-center">
      <i class="fas fa-check me-1"></i> Delivered
    </span>
  {% elif order.actions.delivered.can %}
    <form action="/seller/orders/{{ order._id }}/delivered" method="post" class="m-0">
      <button class="btn btn-outline-success btn-sm">
        <i class="fas fa-box-open me-1"></i> Mark Delivered
      </button>
    </form>
  {% else %}
    <button class="btn btn-outline-success btn-sm" disabled
            title="Send the voucher to the buyer before delivery.">
      <i class="fas fa-box-open me-1"></i> Mark Delivered
    </button>
  {% endif %}
</div>

          
          <div class="mt-auto small text-muted pt-3">
            Keep IDs and totals matching before confirming.
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Progress #}
  {% set steps = ['cart','pending','confirmed','delivered'] %}
  {% set cur = (order.order_status or 'pending')|lower %}
  {% set idx = steps.index(cur) if cur in steps else 0 %}
  <div class="card border-0 shadow-sm mt-3">
    <div class="card-body">
      <h4 class="h6 mb-3"><i class="fas fa-route me-2 text-secondary"></i>Order Progress</h4>
      <ol class="order-stepper" data-step="{{ idx }}">
        <li class="step {{ 'is-done' if idx >= 0 }} {{ 'is-current' if idx == 0 }}"><div class="dot"><i class="fas fa-shopping-basket"></i></div><span>Cart</span></li>
        <li class="step {{ 'is-done' if idx >= 1 }} {{ 'is-current' if idx == 1 }}"><div class="dot"><i class="fas fa-clock"></i></div><span>Pending</span></li>
        <li class="step {{ 'is-done' if idx >= 2 }} {{ 'is-current' if idx == 2 }}"><div class="dot"><i class="fas fa-check"></i></div><span>Confirmed</span></li>
        <li class="step {{ 'is-done' if idx >= 3 }} {{ 'is-current' if idx == 3 }}"><div class="dot"><i class="fas fa-box-open"></i></div><span>Delivered</span></li>
      </ol>
    </div>
  </div>
</div>

<style>
.row.align-items-stretch > [class*="col-"] { display:flex; }  /* equal heights */
.break-any{word-break:break-word;overflow-wrap:anywhere;}
.action-row{padding:.25rem 0;border-bottom:1px dashed #e9ecef;}
.action-row:last-of-type{border-bottom:0;}
.order-stepper{display:flex;justify-content:space-between;list-style:none;padding:0;margin:0;position:relative}
.order-stepper .step{flex:1 1 0;text-align:center;position:relative;padding:0 .25rem}
.order-stepper .step:not(:last-child)::after{content:"";position:absolute;left:50%;right:-50%;top:18px;height:4px;background:#e9ecef;z-index:1}
.order-stepper .dot{width:36px;height:36px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#e9ecef;color:#6c757d;z-index:2;position:relative;box-shadow:0 0 0 2px #fff inset}
.order-stepper .step span{display:block;margin-top:.5rem;font-size:.95rem;color:#6c757d}
.order-stepper .is-done .dot{background:#198754;color:#fff}
.order-stepper .step.is-done::after{background:#198754}
.order-stepper .is-current .dot{box-shadow:0 0 0 4px rgba(25,135,84,.25)}
@media (max-width:576px){.order-stepper .step span{font-size:.85rem}}
</style>
{% endblock %}
