{% extends "base.html" %}

{% block title %}Inventory Management - Medicine Tracker{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Flash Messages -->
    {% if request.session.get('flash_success') %}
    <div class="alert alert-success alert-dismissible fade show mt-3">
        <i class="fas fa-check-circle me-2"></i>
        {{ request.session.flash_success }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    {% if request.session.get('flash_error') %}
    <div class="alert alert-danger alert-dismissible fade show mt-3">
        <i class="fas fa-exclamation-circle me-2"></i>
        {{ request.session.flash_error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="fas fa-boxes me-2 text-primary"></i>Inventory Management</h2>
                    <p class="text-muted mb-0">Manage your medicine stock and pricing</p>
                </div>
                <div>
                    <a href="/seller/add-medicine" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Add New Medicine
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" id="searchInput" class="form-control" placeholder="Search medicines...">
                        </div>
                        <div class="col-md-3">
                            <select id="stockFilter" class="form-select">
                                <option value="">All Stock</option>
                                <option value="in_stock">In Stock</option>
                                <option value="low_stock">Low Stock</option>
                                <option value="out_of_stock">Out of Stock</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="expiryFilter" class="form-select">
                                <option value="">All Items</option>
                                <option value="expired">Expired</option>
                                <option value="expiring_soon">Expiring Soon</option>
                                <option value="fresh">Fresh</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" onclick="clearFilters()" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Stats -->
    <div class="row mb-4 justify-content-center">
        <div class="col-md-2 mb-3">
            <div class="card border-0 bg-primary text-white">
                <div class="card-body text-center">
                    <h4>{{ total_medicines }}</h4>
                    <p class="mb-0">Total Medicines</p>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card border-0 bg-success text-white">
                <div class="card-body text-center">
                    <h4>{{ in_stock_count }}</h4>
                    <p class="mb-0">In Stock</p>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card border-0 bg-warning text-white">
                <div class="card-body text-center">
                    <h4>{{ low_stock_count }}</h4>
                    <p class="mb-0">Low Stock</p>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card border-0 bg-secondary text-white">
                <div class="card-body text-center">
                    <h4>{{ out_of_stock_count }}</h4>
                    <p class="mb-0">Out of Stock</p>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card border-0 bg-danger text-white">
                <div class="card-body text-center">
                    <h4>{{ expired_count }}</h4>
                    <p class="mb-0">Expired</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Medicines Table -->
    {% if medicines %}
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="medicinesTable">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center">Image</th>
                            <th>Medicine Name</th>
                            <th class="text-center">Stock</th>
                            <th class="text-center">Price (Ks)</th>
                            <th class="text-center">Expiry Date</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="medicineTableBody">
                        {% for medicine in medicines %}
                        <tr class="medicine-row" 
                            data-id="{{ medicine._id }}"
                            data-name="{{ medicine.name.lower() }}"
                            data-stock="{{ medicine.stock }}"
                            data-price="{{ medicine.price }}"
                            data-expiry="{{ medicine.expiration_date }}"
                            data-expired="{{ medicine.is_expired|lower }}"
                            data-low-stock="{{ medicine.is_low_stock|lower }}"
                            data-out-of-stock="{{ medicine.is_out_of_stock|lower }}"
                            data-description="{{ medicine.description }}"
                            data-image="{{ medicine.image_url }}">
                            <td class="text-center">
                                <img src="{{ medicine.image_url }}" 
                                    alt="{{ medicine.name }}"
                                    class="img-thumbnail medicine-image"
                                    style="width: 60px; height: 60px; object-fit: cover;"
                                    onerror="this.src='/static/images/placeholder-medicine.png'">
                            </td>
                            <td>
                                <div>
                                    <strong class="d-block">{{ medicine.name }}</strong>
                                    {% if medicine.description %}
                                    <small class="text-muted">{{ medicine.description[:50] }}{% if medicine.description|length > 50 %}...{% endif %}</small>
                                    {% else %}
                                    <small class="text-muted">No description</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="me-2">{{ medicine.stock }}</span>
                                </div>
                            </td>
                            <td class="text-center">
                                <strong class="text-success">{{ medicine.formatted_price }}</strong>
                            </td>
                            <td class="text-center">
                                <div>
                                    {{ medicine.expiration_date }}
                                </div>
                            </td>
                            <td class="text-center">
                                {% if medicine.is_expired %}
                                <span class="badge bg-danger">Expired</span>
                                {% elif medicine.is_out_of_stock %}
                                <span class="badge bg-secondary">Out of Stock</span>
                                {% elif medicine.is_low_stock %}
                                <span class="badge bg-warning">Low Stock</span>
                                {% else %}
                                <span class="badge bg-success">Available</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary me-2" onclick="openEditModal('{{ medicine._id }}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="showDeleteModal('{{ medicine._id }}', '{{ medicine.name }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Footer -->
            <div class="card-footer bg-light mt-5">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div id="paginationInfo" class="text-muted">
                        Showing <span id="currentRange">0-0</span> of <span id="totalItems">0</span> items
                    </div>
                    <nav aria-label="Medicine pagination" class="mt-2 mt-sm-0">
                        <ul class="pagination justify-content-center mb-0" id="paginationControls">
                            <li class="page-item" id="prevPage">
                                <a class="page-link" href="#" onclick="changePage(currentPage - 1)">Previous</a>
                            </li>
                            <span id="pageNumbers" class="d-flex"></span>
                            <li class="page-item" id="nextPage">
                                <a class="page-link" href="#" onclick="changePage(currentPage + 1)">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <i class="fas fa-pills fa-4x text-muted mb-4"></i>
            <h3 class="text-muted mb-3">No medicines in inventory</h3>
            <p class="text-muted mb-4">Start by adding your first medicine to the inventory</p>
            <a href="/seller/add-medicine" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add New Medicine
            </a>
        </div>
    </div>
    {% endif %}

    <!-- No Results Message -->
    <div id="noResults" class="card border-0 shadow-sm" style="display: none;">
        <div class="card-body text-center py-5">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No medicines found</h4>
            <p class="text-muted">Try adjusting your search criteria</p>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                        <h4>Are you sure?</h4>
                        <p class="text-muted">You are about to delete: <strong id="deleteMedicineName"></strong></p>
                        <p class="text-warning">
                            <i class="fas fa-exclamation-circle me-1"></i>
                            This action cannot be undone!
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <a href="#" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i>Yes, Delete Medicine
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Medicine Modal -->
    <div class="modal fade" id="editMedicineModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>Edit Medicine
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="editMedicineForm" method="post" enctype="multipart/form-data">
                    <div class="modal-body">
                        <input type="hidden" id="editMedicineId" name="medicine_id">
                        
                        <div class="text-center mb-4">
                            <img id="currentMedicineImage" src="" 
                                 class="img-thumbnail mb-2" 
                                 style="width: 120px; height: 120px; object-fit: cover;"
                                 onerror="this.src='/static/images/placeholder-medicine.png'">
                            <p class="text-muted small">Current Image</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editName" class="form-label">Medicine Name *</label>
                                    <input type="text" class="form-control" id="editName" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editImage" class="form-label">Update Image</label>
                                    <input type="file" class="form-control" id="editImage" name="medicine_image" 
                                           accept="image/*">
                                    <div class="form-text">Leave empty to keep current image</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editStock" class="form-label">Stock Quantity *</label>
                                    <input type="number" class="form-control" id="editStock" name="stock" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editPrice" class="form-label">Price (Ks) *</label>
                                    <input type="number" class="form-control" id="editPrice" name="price" step="0.01" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editExpirationDate" class="form-label">Expiration Date *</label>
                                    <input type="date" class="form-control" id="editExpirationDate" name="expiration_date" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentPage = 1;
const itemsPerPage = 10;
let filteredMedicines = [];
let allMedicines = [];

document.addEventListener('DOMContentLoaded', function() {
    console.log('🔹 Initializing inventory system...');
    
    // Store all medicines for filtering
    allMedicines = Array.from(document.querySelectorAll('.medicine-row'));
    filteredMedicines = [...allMedicines];
    
    // Initialize filters and pagination
    initializeFilters();
    updatePagination();
    applyFilters();
    
    // Add event listeners
    document.getElementById('searchInput').addEventListener('input', function() {
        currentPage = 1;
        applyFilters();
    });
    
    document.getElementById('stockFilter').addEventListener('change', function() {
        currentPage = 1;
        applyFilters();
    });
    
    document.getElementById('expiryFilter').addEventListener('change', function() {
        currentPage = 1;
        applyFilters();
    });
});

function initializeFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('stockFilter').value = '';
    document.getElementById('expiryFilter').value = '';
}

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const stockFilter = document.getElementById('stockFilter').value;
    const expiryFilter = document.getElementById('expiryFilter').value;
    
    filteredMedicines = allMedicines.filter(medicine => {
        const name = medicine.getAttribute('data-name');
        const stock = parseInt(medicine.getAttribute('data-stock'));
        const expired = medicine.getAttribute('data-expired') === 'true';
        const expiryDate = new Date(medicine.getAttribute('data-expiry'));
        
        const matchesSearch = searchTerm === '' || name.includes(searchTerm);
        
        let matchesStock = true;
        if (stockFilter === 'in_stock') matchesStock = stock > 10;
        else if (stockFilter === 'low_stock') matchesStock = stock > 0 && stock <= 10;
        else if (stockFilter === 'out_of_stock') matchesStock = stock === 0;
        
        let matchesExpiry = true;
        const today = new Date();
        const thirtyDaysFromNow = new Date();
        thirtyDaysFromNow.setDate(today.getDate() + 30);
        
        if (expiryFilter === 'expired') matchesExpiry = expired;
        else if (expiryFilter === 'expiring_soon') matchesExpiry = !expired && expiryDate <= thirtyDaysFromNow && expiryDate > today;
        else if (expiryFilter === 'fresh') matchesExpiry = !expired && expiryDate > thirtyDaysFromNow;
        
        return matchesSearch && matchesStock && matchesExpiry;
    });
    
    updatePagination();
    displayCurrentPage();
}

function updatePagination() {
    const totalPages = Math.ceil(filteredMedicines.length / itemsPerPage);
    const pageNumbersContainer = document.getElementById('pageNumbers');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    
    pageNumbersContainer.innerHTML = '';
    prevPage.classList.toggle('disabled', currentPage === 1);
    nextPage.classList.toggle('disabled', currentPage === totalPages || totalPages === 0);
    
    if (totalPages > 0) {
        for (let i = 1; i <= totalPages; i++) {
            const pageItem = document.createElement('li');
            pageItem.className = 'page-item' + (i === currentPage ? ' active' : '');
            
            const pageLink = document.createElement('a');
            pageLink.className = 'page-link';
            pageLink.href = '#';
            pageLink.textContent = i;
            pageLink.onclick = (e) => {
                e.preventDefault();
                changePage(i);
            };
            
            pageItem.appendChild(pageLink);
            pageNumbersContainer.appendChild(pageItem);
        }
    }
    
    const startItem = (currentPage - 1) * itemsPerPage + 1;
    const endItem = Math.min(currentPage * itemsPerPage, filteredMedicines.length);
    document.getElementById('currentRange').textContent = `${startItem}-${endItem}`;
    document.getElementById('totalItems').textContent = filteredMedicines.length;
    document.getElementById('noResults').style.display = filteredMedicines.length === 0 ? 'block' : 'none';
}

function displayCurrentPage() {
    allMedicines.forEach(medicine => medicine.style.display = 'none');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    filteredMedicines.slice(startIndex, endIndex).forEach(medicine => {
        medicine.style.display = '';
    });
}

function changePage(page) {
    const totalPages = Math.ceil(filteredMedicines.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updatePagination();
        displayCurrentPage();
    }
}

function clearFilters() {
    initializeFilters();
    currentPage = 1;
    applyFilters();
}

// Delete Medicine Functions
function showDeleteModal(medicineId, medicineName) {
    document.getElementById('deleteMedicineName').textContent = medicineName;
    const deleteBtn = document.getElementById('confirmDeleteBtn');
    deleteBtn.href = `/seller/medicine/delete/${medicineId}`;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

// Edit Medicine Functions - RENAMED to avoid conflicts
function openEditModal(medicineId) {
    console.log('Opening edit modal for:', medicineId);
    
    const medicineRow = document.querySelector(`.medicine-row[data-id="${medicineId}"]`);
    if (!medicineRow) {
        console.error('Medicine row not found for ID:', medicineId);
        return;
    }
    
    // Populate form fields
    document.getElementById('editMedicineId').value = medicineId;
    document.getElementById('editName').value = medicineRow.querySelector('strong').textContent;
    document.getElementById('editDescription').value = medicineRow.getAttribute('data-description') || '';
    document.getElementById('editStock').value = medicineRow.getAttribute('data-stock');
    document.getElementById('editPrice').value = medicineRow.getAttribute('data-price');
    document.getElementById('editExpirationDate').value = medicineRow.getAttribute('data-expiry');
    
    // Set current image
    const currentImage = document.getElementById('currentMedicineImage');
    currentImage.src = medicineRow.getAttribute('data-image');
    
    // Set form action
    const editForm = document.getElementById('editMedicineForm');
    editForm.action = `/seller/medicine/update/${medicineId}`;
    
    // Show the modal
    const editModal = new bootstrap.Modal(document.getElementById('editMedicineModal'));
    editModal.show();
}
</script>

<style>
.badge-sm { font-size: 0.7em; }
.table th { border-top: none; font-weight: 600; color: #495057; }
.btn-group-sm > .btn { padding: 0.25rem 0.5rem; }
.card { border-radius: 10px; }
.medicine-image { transition: transform 0.2s ease; }
.medicine-image:hover { transform: scale(1.1); }
.table th { font-weight: 600; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; }
</style>
{% endblock %}