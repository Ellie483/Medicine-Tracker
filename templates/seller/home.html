{% extends "base.html" %}

{% block title %}Seller Dashboard - Medicine Tracker{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="fas fa-store me-2 text-primary"></i>Welcome back, {{ current_user.username }}!</h2>
                    <p class="text-muted mb-0">Manage your pharmacy and track your business</p>
                </div>
                <div class="text-end">
                    <h5 class="text-muted mb-0">{{ pharmacy_name }}</h5>
                    <small class="text-muted">Your Pharmacy</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-pills fa-3x text-primary"></i>
                    </div>
                    <h3 class="fw-bold text-primary">{{ total_medicines }}</h3>
                    <p class="text-muted mb-3">Total Medicines</p>
                    <a href="/seller/inventory" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-boxes me-1"></i>Manage Inventory
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-shopping-cart fa-3x text-success"></i>
                    </div>
                    <h3 class="fw-bold text-success">{{ orders_received }}</h3>
                    <p class="text-muted mb-3">Paid Orders</p>
                    <a href="/seller/order" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-clipboard-list me-1"></i>View Orders
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-money-bill-wave fa-3x text-info"></i>
                    </div>
                    <h3 class="fw-bold text-info">{{ total_revenue }} Ks</h3>
                    <p class="text-muted mb-3">Total Revenue</p>
                    <a href="#chart_section" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-chart-bar me-1"></i>View Analytics
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-chart-line fa-3x text-warning"></i>
                    </div>
                    <h3 class="fw-bold text-warning">{{ total_profit }} Ks</h3>
                    <p class="text-muted mb-3">Total Profit</p>
                    <a href="#chart_section" class="btn btn-outline-warning btn-sm">
                        <i class="fas fa-analytics me-1"></i>View Analytics
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4" id="chart_section">
        <!-- Pie Chart - Top Selling Medicines -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2 text-primary"></i>Top Selling Medicines
                    </h5>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label small">Start Date</label>
                            <input type="date" id="pieStartDate" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">End Date</label>
                            <input type="date" id="pieEndDate" class="form-control form-control-sm">
                        </div>
                    </div>
                    <button onclick="updatePieChart()" class="btn btn-primary btn-sm mt-2">
                        <i class="fas fa-sync me-1"></i>Apply Filter
                    </button>
                </div>
                <div class="card-body">
                    <canvas id="pieChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Line Chart - Profit Trend -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2 text-success"></i>Revenue & Profit Trend
                    </h5>
                    <div class="row mt-3 g-2">
                        <div class="col-md-4">
                            <select id="timeUnit" class="form-select form-select-sm" onchange="changeTimeUnit()">
                                <option value="day">Daily</option>
                                <option value="month">Monthly</option>
                                <option value="year">Yearly</option>
                            </select>
                        </div>
                        
                        <!-- Daily Month Selector -->
                        <div class="col-md-6" id="dailySelector">
                            <div class="input-group input-group-sm">
                                <button class="btn btn-outline-secondary" onclick="changeMonth(-1)">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <input type="text" id="currentMonth" class="form-control text-center" readonly>
                                <button class="btn btn-outline-secondary" onclick="changeMonth(1)">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Monthly Year Selector -->
                        <div class="col-md-6" id="monthlySelector" style="display: none;">
                            <div class="input-group input-group-sm">
                                <button class="btn btn-outline-secondary" onclick="changeYear(-1)">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <input type="text" id="currentYear" class="form-control text-center" readonly>
                                <button class="btn btn-outline-secondary" onclick="changeYear(1)">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-2">
                            <button onclick="updateLineChart()" class="btn btn-success btn-sm w-100">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="lineChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <!-- <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2 text-info"></i>Recent Paid Orders
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Medicine</th>
                                    <th>Qty</th>
                                    <th>Revenue</th>
                                    <th>Profit</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="recentOrders">
                                <tr>
                                    <td colspan="7" class="text-center">Loading recent orders...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div> -->
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Global variables
let pieChartInstance = null;
let lineChartInstance = null;
let dashboardData = null;
let currentMonth = new Date();
let currentYear = new Date().getFullYear();
let currentTimeUnit = 'day';

// Initialize dashboard with data from backend
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔹 Initializing dashboard...');
    
    try {
        // Parse the dashboard data passed from backend
        dashboardData = JSON.parse('{{ dashboard_data | safe }}');
        console.log('✅ Dashboard data loaded:', dashboardData);
        
        // Set default dates for pie chart (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        document.getElementById('pieStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        document.getElementById('pieEndDate').value = today.toISOString().split('T')[0];
        
        // Set current displays
        updateMonthDisplay();
        updateYearDisplay();
        
        // Update all components
        updatePieChart();
        updateLineChart();
        updateRecentOrders();
        
    } catch (error) {
        console.error('❌ Error parsing dashboard data:', error);
        document.getElementById('recentOrders').innerHTML = 
            '<tr><td colspan="7" class="text-center text-danger">Error loading data</td></tr>';
    }
});

function updatePieChart() {
    if (!dashboardData) return;
    
    const startDate = new Date(document.getElementById('pieStartDate').value);
    const endDate = new Date(document.getElementById('pieEndDate').value);
    endDate.setHours(23, 59, 59, 999);
    
    // Filter orders by date range
    const filteredOrders = dashboardData.orders.filter(order => {
        const orderDate = new Date(order.created_at);
        return orderDate >= startDate && orderDate <= endDate;
    });
    
    // Calculate medicine sales from order items
    const medicineSales = {};
    filteredOrders.forEach(order => {
        order.items.forEach(item => {
            const medicineName = item.medicine_name;
            if (!medicineSales[medicineName]) {
                medicineSales[medicineName] = 0;
            }
            medicineSales[medicineName] += item.quantity;
        });
    });
    
    // Sort by quantity and get top 5
    const sortedSales = Object.entries(medicineSales)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 5);
    
    const totalSold = Object.values(medicineSales).reduce((sum, val) => sum + val, 0);
    
    // Prepare data for chart
    const labels = [];
    const data = [];
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    
    sortedSales.forEach(([medicine, sales], index) => {
        const percentage = totalSold > 0 ? ((sales / totalSold) * 100).toFixed(1) : 0;
        labels.push(`${medicine} (${percentage}%)`);
        data.push(sales);
    });
    
    // Add "Others" category
    const otherSales = totalSold - sortedSales.reduce((sum, [,sales]) => sum + sales, 0);
    if (otherSales > 0) {
        const percentage = totalSold > 0 ? ((otherSales / totalSold) * 100).toFixed(1) : 0;
        labels.push(`Others (${percentage}%)`);
        data.push(otherSales);
    }
    
    // Create or update pie chart
    const ctx = document.getElementById('pieChart').getContext('2d');
    
    if (pieChartInstance) {
        pieChartInstance.destroy();
    }
    
    pieChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const percentage = totalSold > 0 ? ((value / totalSold) * 100).toFixed(1) : 0;
                            return `${label.split(' (')[0]}: ${value} units (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function updateLineChart() {
    if (!dashboardData) return;
    
    const orders = dashboardData.orders;
    let labels = [];
    let revenueData = [];
    let profitData = [];
    
    if (currentTimeUnit === 'day') {
        // Daily profit for current month
        const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
        const dailyRevenue = new Array(daysInMonth).fill(0);
        const dailyProfit = new Array(daysInMonth).fill(0);
        
        orders.forEach(order => {
            const orderDate = new Date(order.created_at);
            if (orderDate.getMonth() === currentMonth.getMonth() && 
                orderDate.getFullYear() === currentMonth.getFullYear()) {
                const day = orderDate.getDate() - 1;
                dailyRevenue[day] += order.total_amount;
                dailyProfit[day] += order.profit;
            }
        });
        
        labels = Array.from({length: daysInMonth}, (_, i) => `Day ${i + 1}`);
        revenueData = dailyRevenue;
        profitData = dailyProfit;
        
    } else if (currentTimeUnit === 'month') {
        // Monthly profit for current year
        const monthlyRevenue = new Array(12).fill(0);
        const monthlyProfit = new Array(12).fill(0);
        
        orders.forEach(order => {
            const orderDate = new Date(order.created_at);
            if (orderDate.getFullYear() === currentYear) {
                const month = orderDate.getMonth();
                monthlyRevenue[month] += order.total_amount;
                monthlyProfit[month] += order.profit;
            }
        });
        
        labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        revenueData = monthlyRevenue;
        profitData = monthlyProfit;
        
    } else if (currentTimeUnit === 'year') {
        // Yearly profit - show all years
        const yearlyRevenue = {};
        const yearlyProfit = {};
        
        orders.forEach(order => {
            const year = new Date(order.created_at).getFullYear();
            yearlyRevenue[year] = (yearlyRevenue[year] || 0) + order.total_amount;
            yearlyProfit[year] = (yearlyProfit[year] || 0) + order.profit;
        });
        
        // Get sorted years
        const years = Object.keys(yearlyRevenue).map(Number).sort();
        labels = years.map(year => year.toString());
        revenueData = years.map(year => yearlyRevenue[year]);
        profitData = years.map(year => yearlyProfit[year]);
    }
    
    // Create or update line chart
    const ctx = document.getElementById('lineChart').getContext('2d');
    
    if (lineChartInstance) {
        lineChartInstance.destroy();
    }
    
    lineChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Revenue (Ks)',
                    data: revenueData,
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Profit (Ks)',
                    data: profitData,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount (Ks)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: currentTimeUnit === 'day' ? 'Days' : 
                              currentTimeUnit === 'month' ? 'Months' : 'Years'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const datasetLabel = context.dataset.label || '';
                            const value = context.raw || 0;
                            return `${datasetLabel}: ${value.toLocaleString()} Ks`;
                        }
                    }
                }
            }
        }
    });
}

function changeTimeUnit() {
    currentTimeUnit = document.getElementById('timeUnit').value;
    
    // Show/hide appropriate selectors
    document.getElementById('dailySelector').style.display = 
        currentTimeUnit === 'day' ? 'block' : 'none';
    document.getElementById('monthlySelector').style.display = 
        currentTimeUnit === 'month' ? 'block' : 'none';
    
    updateLineChart();
}

function changeMonth(direction) {
    currentMonth.setMonth(currentMonth.getMonth() + direction);
    updateMonthDisplay();
    updateLineChart();
}

function changeYear(direction) {
    currentYear += direction;
    updateYearDisplay();
    updateLineChart();
}

function updateMonthDisplay() {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    const monthName = monthNames[currentMonth.getMonth()];
    const year = currentMonth.getFullYear();
    document.getElementById('currentMonth').value = `${monthName} ${year}`;
}

function updateYearDisplay() {
    document.getElementById('currentYear').value = currentYear;
}

function updateRecentOrders() {
    if (!dashboardData) return;
    
    const recentOrders = dashboardData.orders
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .slice(0, 8);
    
    const ordersHtml = recentOrders.map(order => {
        const mainItem = order.items[0];
        const additionalItems = order.items.length > 1 ? ` +${order.items.length - 1} more` : '';
        
        return `
            <tr>
                <td><small>${order.order_id.substring(0, 8)}...</small></td>
                <td>${mainItem.medicine_name}${additionalItems}</td>
                <td>${mainItem.quantity}</td>
                <td>${order.total_amount.toLocaleString()} Ks</td>
                <td class="text-success fw-bold">${order.profit.toLocaleString()} Ks</td>
                <td><span class="badge bg-success">${order.order_status}</span></td>
                <td><small>${formatDate(order.created_at)}</small></td>
            </tr>
        `;
    }).join('');
    
    document.getElementById('recentOrders').innerHTML = ordersHtml || 
        '<tr><td colspan="7" class="text-center">No paid orders yet</td></tr>';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}
</script>

<style>
.card {
    transition: transform 0.2s ease-in-out;
    border-radius: 10px;
}

.card:hover {
    transform: translateY(-2px);
}

.btn {
    transition: all 0.2s ease-in-out;
    border-radius: 8px;
}

.chart-container {
    position: relative;
    height: 250px;
    width: 100%;
}

.input-group {
    width: 180px;
}

#currentMonth, #currentYear {
    background-color: white;
    font-weight: 500;
    text-align: center;
}

.table th {
    font-size: 0.9rem;
    font-weight: 600;
}

.table td {
    font-size: 0.9rem;
    vertical-align: middle;
}

.badge {
    font-size: 0.75rem;
}

.text-success {
    color: #28a745 !important;
}

#chart_section {
  scroll-margin-top: 100px; /* leaves 100px space when scrolled into view */
}
</style>
{% endblock %}