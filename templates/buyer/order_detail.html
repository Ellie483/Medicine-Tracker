{% extends "base.html" %}
{% block title %}Order Details · Medicine Tracker{% endblock %}

{% macro status_chip(s) -%}
  {% set s = (s or 'cart')|lower %}
  {% if s == 'delivered' %}
    <span class="badge badge-green"><i class="fas fa-box-open me-1"></i>Delivered</span>
  {% elif s == 'confirmed' %}
    <span class="badge badge-green"><i class="fas fa-check me-1"></i>Confirmed</span>
  {% elif s == 'pending' %}
    <span class="badge badge-green"><i class="fas fa-clock me-1"></i>Pending</span>
  {% else %}
    <span class="badge badge-green"><i class="fas fa-shopping-basket me-1"></i>Cart</span>
  {% endif %}
{%- endmacro %}

{% macro payment_chip(s) -%}
  {% set s = (s or 'unpaid')|lower %}
  {% if s == 'paid' %}
    <span class="badge badge-green"><i class="fas fa-check me-1"></i>Paid</span>
  {% elif s == 'proof_uploaded' %}
    <span class="badge badge-green"><i class="fas fa-hourglass-half me-1"></i>Under Review</span>
  {% elif s == 'rejected' %}
    <span class="badge badge-green"><i class="fas fa-times me-1"></i>Proof Rejected</span>
  {% else %}
    <span class="badge badge-green"><i class="fas fa-credit-card me-1"></i>Pending Payment</span>
  {% endif %}
{%- endmacro %}


{% block content %}
<div class="container-xxl py-3">

  <!-- top bar: back + totals + chips -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <a href="/buyer/orders" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left me-1"></i>Back to Orders</a>
    <div class="d-flex flex-column align-items-end">
      <div class="fw-bold text-success fs-4">{{ order.formatted_total }}</div>
      <div class="d-flex gap-2 mt-1">
        {{ status_chip(order.order_status or order.status) }}
        {{ payment_chip(order.payment_status) }}
      </div>
    </div>
  </div>

  {# ---------- ROW 1: ITEMS (left) + PHARMACY & PAYMENT (right) ---------- #}
<div class="row g-4 align-items-stretch">

  <!-- LEFT: Order Items -->
  <div class="col-lg-8">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-muted">
            <i class="fas fa-calendar me-1"></i>{{ order.created_at_str or order.created_at or '—' }}
          </div>
          <div class="fw-semibold break-any">Order #{{ order._id }}</div>
        </div>
        <hr>
        <h4 class="h6"><i class="fas fa-pills me-2 text-primary"></i>Order Items</h4>

        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Medicine</th>
                <th class="text-center">Qty</th>
                <th class="text-end">Price</th>
                <th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for it in order.get('items', []) %}
                <tr>
                  <td class="break-any">{{ it['medicine_name'] }}</td>
                  <td class="text-center">{{ it['quantity'] }}</td>
                  <td class="text-end">₹{{ '%.2f'|format(it['price']) }}</td>
                  <td class="text-end">₹{{ '%.2f'|format((it['quantity'] or 0) * (it['price'] or 0)) }}</td>
                </tr>
              {% else %}
                <tr><td colspan="4" class="text-center text-muted">No items</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT: Pharmacy + Payment (stacked) -->
  <div class="col-lg-4 d-flex flex-column gap-3">
    <!-- Pharmacy -->
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <h4 class="h6 mb-2"><i class="fas fa-store me-2 text-info"></i>Pharmacy</h4>
        <div class="fw-semibold break-any">{{ order.pharmacy_name or '—' }}</div>

        {% set addr = order.pharmacy_address %}
        {% if addr %}
          {% if addr is mapping %}
            <div class="text-muted small break-any mt-1">
              <i class="fas fa-location-dot me-1"></i>
              {{ addr.address }}{% if addr.city %}, {{ addr.city }}{% endif %}
            </div>
          {% else %}
            <div class="text-muted small break-any mt-1">
              <i class="fas fa-location-dot me-1"></i>{{ addr }}
            </div>
          {% endif %}
        {% endif %}
      </div>
    </div>

    <!-- Payment -->
    <div id="payment" class="card border-0 shadow-sm">
      <div class="card-body">
        <h4 class="h6 mb-2"><i class="fas fa-credit-card me-2 text-warning"></i>Payment</h4>
        <div class="mb-2">{{ payment_chip(order.payment_status) }}</div>

        {% set cur = (order.order_status or order.status or 'cart')|lower %}
        {% if cur in ['cart','pending'] and (order.payment_status or 'unpaid') in ['unpaid','rejected'] %}
          {% if order.payment_status == 'rejected' and order.payment and order.payment.rejected_reason %}
            <div class="alert alert-danger small py-2 mb-2 break-any">
              <i class="fas fa-circle-exclamation me-1"></i>Rejected: {{ order.payment.rejected_reason }}
            </div>
          {% endif %}
          <button class="btn btn-success w-100" id="openSubmitModalBtn">
            <i class="fas fa-paper-plane me-1"></i>Submit Order
          </button>

        {% elif order.payment_status == 'proof_uploaded' %}
          <div class="alert alert-info small mb-0">
            <i class="fas fa-hourglass-half me-1"></i>Payment under review.
          </div>
          {% if order.payment and order.payment.receipt_path %}
            <a class="btn btn-outline-secondary btn-sm mt-2 w-100"
               href="{{ order.payment.receipt_path }}" target="_blank">
              <i class="fas fa-file-image me-1"></i>View Uploaded Proof
            </a>
          {% endif %}

        {% elif order.payment_status == 'paid' and order.payment and order.payment.receipt_path %}
          <a class="btn btn-outline-success w-100"
             href="{{ order.payment.receipt_path }}" target="_blank">
            <i class="fas fa-download me-1"></i>Download Receipt
          </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# ---------- ROW 2: FULL-WIDTH ORDER PROGRESS ---------- #}
{% set steps = ['cart','pending','confirmed','delivered'] %}
{% set cur = (order.order_status or order.status or 'cart')|lower %}
{% set idx = steps.index(cur) if cur in steps else 0 %}

<div class="row g-4 mt-0">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <h4 class="h6 mb-3"><i class="fas fa-route me-2 text-secondary"></i>Order Progress</h4>
        <ol class="order-stepper" data-step="{{ idx }}">
          <li class="step {{ 'is-done' if idx >= 0 }}">
            <div class="dot"><i class="fas fa-shopping-basket"></i></div>
            <span>Cart</span>
          </li>
          <li class="step {{ 'is-done' if idx >= 1 }} {{ 'is-current' if idx == 1 }}">
            <div class="dot"><i class="fas fa-clock"></i></div>
            <span>Pending</span>
          </li>
          <li class="step {{ 'is-done' if idx >= 2 }} {{ 'is-current' if idx == 2 }}">
            <div class="dot"><i class="fas fa-check"></i></div>
            <span>Confirmed</span>
          </li>
          <li class="step {{ 'is-done' if idx >= 3 }} {{ 'is-current' if idx == 3 }}">
            <div class="dot"><i class="fas fa-box-open"></i></div>
            <span>Delivered</span>
          </li>
        </ol>
      </div>
    </div>
  </div>
</div>

  
  

{# ---------- Submit Order Modal ---------- #}
<div class="modal fade" id="submitPaymentModal" tabindex="-1" aria-labelledby="submitPaymentLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <form class="modal-content" method="post" action="/buyer/orders/{{ order._id }}/submit_and_upload"
          enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title" id="submitPaymentLabel">
          <i class="fas fa-paper-plane me-2"></i>Submit Order & Upload Payment
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12">
            <div class="form-text">Order ID</div>
            <div class="fw-semibold break-any">{{ order._id }}</div>
          </div>

          <div class="col-md-8">
            <label class="form-label">Address</label>
            <input name="address_line" class="form-control" placeholder="Street / House / Block" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">City</label>
            <input name="city" class="form-control" placeholder="Your city" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Payment ID / Reference</label>
            <input name="payment_id" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Payment Proof (Image/PDF)</label>
            <input type="file" name="file" class="form-control" accept="image/*,application/pdf" required>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary"><i class="fas fa-check me-1"></i>Submit</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* Make long texts readable everywhere */
  .card, .table, .badge, .form-control { font-size: 1rem; }
  .break-any { word-break: break-word; overflow-wrap: anywhere; }

  /* --- Stepper --- */
  .order-stepper{
    display:flex; justify-content:space-between; list-style:none; padding:0; margin:0; position:relative;
  }
  .order-stepper .step{ flex:1 1 0; text-align:center; position:relative; padding:0 .25rem; }
  .order-stepper .step:not(:last-child)::after{
    content:""; position:absolute; left:50%; right:-50%; top:18px; height:4px;
    background:#e9ecef; z-index:1;
  }
  .order-stepper .dot{
    width:36px; height:36px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center;
    background:#e9ecef; color:#6c757d; z-index:2; position:relative; box-shadow:0 0 0 2px #fff inset;
  }
  .order-stepper .step span{ display:block; margin-top:.5rem; font-size:.95rem; color:#6c757d; }

  /* done */
  .order-stepper .is-done .dot{ background:#198754; color:#fff; }
  .order-stepper .step.is-done::after{ background:#198754; }

  /* current (highlight ring) */
  .order-stepper .is-current .dot{ box-shadow:0 0 0 4px rgba(25,135,84,.25); }

  @media (max-width:576px){
    .order-stepper .step span{ font-size:.85rem; }
  }
  .badge-green {
  background-color: #198754 !important; /* Bootstrap green */
  color: #fff !important;
  font-weight: 600;
  padding: .4rem .75rem;
  font-size: .85rem;
}

/* Align right Payment card height with left column */
@media (min-width: 992px) {
  .order-columns {
    display: flex;
    align-items: stretch;
    gap: 1.5rem;
  }
  .order-columns > .col-lg-8,
  .order-columns > .col-lg-4 {
    display: flex;
    flex-direction: column;
  }
  .order-columns .card {
    flex: 1; /* equal height */
  }
}

/* Make submit button green */
#openSubmitModalBtn.btn-primary {
  background-color: #198754 !important;
  border-color: #198754 !important;
}
@media (min-width: 992px){
  .order-columns{ display:flex; align-items:stretch; gap:1.5rem; }
  .order-columns > .col-lg-8,
  .order-columns > .col-lg-4{ display:flex; flex-direction:column; }
  .order-columns .card{ flex:1; }
}
/* Make the submit button green even under Bootstrap overrides */
#openSubmitModalBtn.btn-success{
  background-color:#198754!important;
  border-color:#198754!important;
}
.break-any{ word-break:break-word; overflow-wrap:anywhere; }

</style>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const btn = document.getElementById('openSubmitModalBtn');
    if (btn) {
      btn.addEventListener('click', function(){
        const m = new bootstrap.Modal(document.getElementById('submitPaymentModal'));
        m.show();
      });
    }
  })();
</script>
{% endblock %}
