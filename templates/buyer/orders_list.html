{% extends "base.html" %}
{% block title %}My Orders · Medicine Tracker{% endblock %}

{% block content %}
<div class="container-xxl py-3">

  <!-- Header -->
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3 orders-head">
    <div>
      <h2 class="h3 mb-1"><i class="fas fa-cubes me-2"></i>My Orders</h2>
      <p class="orders-subtle mb-0">Track and manage your medicine orders</p>
    </div>
  </div>

  <!-- Search + sort -->
  <div class="d-flex flex-wrap gap-2 align-items-center mb-3 orders-controls">
    <div class="flex-grow-1">
      <div class="input-group">
        <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
        <input id="orderSearch" class="form-control" placeholder="Search by pharmacy or medicine name…">
      </div>
    </div>
    <div>
      {# set current sort from query, default newest first #}
{% set sort = request.query_params.get('sort','created_desc') %}

<form id="sortForm" method="get" class="m-0">
  {# preserve other filters in the URL when sorting #}
  <input type="hidden" name="q" value="{{ request.query_params.get('q','') }}">
  <input type="hidden" name="status" value="{{ request.query_params.get('status','') }}">

  <div class="input-group">
    <span class="input-group-text"><i class="fas fa-arrow-up-short-wide"></i></span>
    <select name="sort" id="sortSelect" class="form-select"
            onchange="document.getElementById('sortForm').submit()">
      <option value="created_desc" {{ 'selected' if sort=='created_desc' }}>Newest First</option>
      <option value="created_asc"  {{ 'selected' if sort=='created_asc'  }}>Oldest First</option>
      <option value="total_desc"   {{ 'selected' if sort=='total_desc'   }}>Amount: High → Low</option>
      <option value="total_asc"    {{ 'selected' if sort=='total_asc'    }}>Amount: Low → High</option>
    </select>
  </div>
</form>

    </div>
  </div>

  <!-- Filter chips -->
  <div class="d-flex flex-wrap gap-2 mb-3" id="statusFilters">
    <button class="btn btn-sm btn-success filter-btn active" data-filter="all">All Orders ({{ orders|length }})</button>
    <button class="btn btn-sm btn-light filter-btn" data-filter="delivered">Delivered</button>
    <button class="btn btn-sm btn-light filter-btn" data-filter="confirmed">Confirmed</button>
    <button class="btn btn-sm btn-light filter-btn" data-filter="pending">Pending</button>
    <button class="btn btn-sm btn-light filter-btn" data-filter="cart">Cart</button>
  </div>

  {% if orders and orders|length > 0 %}
    <div class="row g-3" id="ordersContainer">
      {% for order in orders %}
        {% set items = order.get('items', []) %}
        {% set item_count = items|length %}
        {% set first_name = items[0]['medicine_name'] if item_count else '—' %}
        {% set qty_total = items|map(attribute='quantity')|sum if item_count else 0 %}

        <div class="col-12 col-lg-6 col-xl-4 order-card-wrapper"
             data-status="{{ order.order_status|lower }}"
             data-search="{{ (order.pharmacy_name ~ ' ' ~ (items|map(attribute='medicine_name')|join(' ')))|lower }}">
          <article class="card border-0 shadow-sm order-card h-100">
            <div class="card-body d-flex flex-column gap-3">

              <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                  <i class="fas fa-calendar me-1"></i>{{ order.created_at_str or order.created_at or '—' }}
                </div>
                <span class="small">Order #{{ order._id }}</span>
              </div>

              <div class="d-flex flex-wrap gap-2">
                <span class="badge bg-light text-dark">{{ order.order_status|title }}</span>
                <span class="badge bg-light text-dark">{{ order.payment_status|title }}</span>
              </div>

              <div class="fw-semibold fs-5 order-total">{{ order.formatted_total }}</div>

              <div class="pharm-chip px-3 py-2 d-flex align-items-center">
                <i class="fas fa-building-columns me-2 text-muted"></i>
                <span class="fw-semibold">{{ order.pharmacy_name or '—' }}</span>
              </div>

              <div class="small">
                <i class="fas fa-box me-1 text-muted"></i>
                {% if item_count == 0 %}No items
                {% elif item_count == 1 %}
                  {{ first_name }} · Qty {{ qty_total }}
                {% else %}
                  {{ first_name }} · Qty {{ qty_total }} <span class="text-muted">+{{ item_count - 1 }} more</span>
                {% endif %}
              </div>

              <div class="mt-auto">
                <a class="btn btn-outline-secondary w-100" href="/buyer/orders/{{ order._id }}">
                  <i class="fas fa-eye me-1"></i>View Details
                </a>
              </div>

            </div>
          </article>
        </div>
      {% endfor %}
    </div>
    <div id="noResults" class="text-center py-5 d-none">
      <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
      <h5 class="fw-semibold mb-1">No matching orders</h5>
      <p class="text-muted">Try adjusting your search or filters.</p>
    </div>
  {% else %}
    <div class="text-center py-5">
      <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
      <h3 class="fw-semibold mb-1">No orders yet</h3>
      <p class="text-muted mb-4">Start browsing medicines to place your first order.</p>
      <a href="/buyer/medicines" style="
  display:inline-block;
  background: linear-gradient(90deg, #0e8a83, #16c2b3);
  color:#fff;
  padding:.6rem 1.2rem;
  border-radius:10px;
  font-weight:600;
  font-size:1rem;
  text-align:center;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(14,138,131,.2);
  transition:all .2s ease;
  text-decoration:none;
">
  <i class="fas fa-pills me-2"></i>Browse Medicines
</a>

    </div>
  {% endif %}
  
</div>

<style>
  /* ===== Theme tokens (same palette as navbar) ===== */
  :root{
    --ref-deep:#0e8a83;     /* deep teal */
    --ref-teal:#16c2b3;     /* bright teal */
    --ref-mint:#c8f3ea;     /* very pale mint */
    --ink:#0c1b1c;
  }
  html, body {
  height: 100%; /* let html stretch to full viewport */
  background: linear-gradient(180deg, var(--ref-mint) 0%, #ffffff 100%) !important;
  background-attachment: fixed;
}

  /* Header */
  .orders-head h2 i{
    color: var(--ref-deep);
  }
  .orders-subtle{ color:#6b7b7c; }

  /* Search & sort controls */
  .orders-controls .input-group-text{
    background:#fff;
    border:1px solid #dbe8e6;
    border-right:none;
    color:#5b6a6a;
  }
  .orders-controls .form-control,
  .orders-controls .form-select{
    border:1px solid #dbe8e6;
    border-radius:.8rem;
  }
  .orders-controls .form-control:focus,
  .orders-controls .form-select:focus{
    border-color: var(--ref-teal);
    box-shadow: 0 0 0 .2rem rgba(22,194,179,.18);
  }
  .orders-controls .input-group > :first-child{
    border-radius:.9rem 0 0 .9rem;
  }
  .orders-controls .input-group > :last-child{
    border-radius:0 .9rem .9rem 0;
  }

  /* Filter chips (buttons) */
  .filter-btn{
    border-radius: 999px;
    background:#ecfffb;
    color:#0a615c;
    border:1px solid rgba(14,138,131,.15);
    padding:.4rem .85rem;
    font-weight:600;
  }
  .filter-btn:hover{ background:#e4fbf6; }
  .filter-btn.active{
    background: linear-gradient(90deg, var(--ref-deep), var(--ref-teal));
    color:#fff;
    border-color: transparent;
    box-shadow: 0 2px 10px rgba(14,138,131,.22);
  }

  /* Order card */
  .order-card{
    border-radius: 14px;
    border: 1px solid rgba(14,138,131,.10);
    background: #ffffffcc;
    backdrop-filter: saturate(120%) blur(2px);
    transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
  }
  .order-card:hover{
    transform: translateY(-1px);
    border-color: rgba(14,138,131,.20);
    box-shadow: 0 10px 22px rgba(12,27,28,.08);
  }

  /* Left accent by status */
  .order-card-wrapper[data-status="delivered"] .order-card{ box-shadow: inset 4px 0 0 0 #19c37d; }
  .order-card-wrapper[data-status="confirmed"] .order-card{ box-shadow: inset 4px 0 0 0 #12a596; }
  .order-card-wrapper[data-status="pending"]   .order-card{ box-shadow: inset 4px 0 0 0 #ffb020; }
  .order-card-wrapper[data-status="cart"]      .order-card{ box-shadow: inset 4px 0 0 0 #9aa4a6; }

  /* Status badges */
  .badge{ border-radius:.65rem; font-weight:700; }
  .badge.bg-light{
    background:#f2f8f7 !important;
    color:#0d4b47 !important;
    border:1px solid rgba(14,138,131,.12);
  }

  /* Total amount */
  .order-total{
    color: var(--ref-deep);
    background: #f0fbf9;
    border:1px dashed rgba(14,138,131,.18);
    border-radius:.75rem;
    padding:.35rem .6rem;
    display:inline-block;
    font-weight:700;
  }

  /* Pharmacy chip */
  .pharm-chip{
    background:#f5fcfb;
    border:1px solid rgba(14,138,131,.12);
    border-radius:.7rem;
  }

  /* View button */
  .btn-outline-secondary{
    --bs-btn-color: var(--ref-deep);
    --bs-btn-border-color: rgba(14,138,131,.35);
    --bs-btn-hover-bg: var(--ref-teal);
    --bs-btn-hover-border-color: var(--ref-teal);
    --bs-btn-hover-color: #fff;
    border-radius:.8rem;
    font-weight:600;
  }

  /* Tiny helper for section spacing */
  .gap-6{ gap:1.5rem; }

  /* --- Hard stop for page-to-page weird transitions --- */

/* Don’t auto-animate scroll between pages/anchors */
html { scroll-behavior: auto !important; }

/* If you had any page fade classes, neutralize them */
.fade-in, .slide-in { animation: none !important; }

/* Keep transitions lightweight (no transform/position changes) */
a, .nav-link, .btn, .card, .form-control, .dropdown-menu {
  transition: background-color .12s ease, color .12s ease, border-color .12s ease, box-shadow .12s ease !important;
}

/* Remove lift/slide effects on hover/focus */
.navbar .nav-link:hover,
.card:hover,
.btn:hover,
.btn:active {
  transform: none !important;
}

/* Quantity buttons: no pop animation on press */
.qty-wrap .qty-btn,
.qty-wrap .qty-btn:hover,
.qty-wrap .qty-btn:active {
  transform: none !important;
  transition: border-color .12s ease, box-shadow .12s ease, background-color .12s ease !important;
}

/* If any global “transition: all …” slipped in somewhere, disable transforms */
*,
*::before,
*::after {
  transition-property: color, background-color, border-color, box-shadow, opacity !important;
}

/* Optional: if you want to nuke *all* motion entirely, uncomment:
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after { animation: none !important; transition: none !important; }
}
*/

</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("orderSearch");
    const sortSelect  = document.getElementById("sortSelect");
    const filterBtns  = document.querySelectorAll(".filter-btn");
    const container   = document.getElementById("ordersContainer");
    const cards       = Array.from(document.querySelectorAll(".order-card-wrapper"));
    const noResults   = document.getElementById("noResults");
  
    function applyFilters() {
      const q = (searchInput?.value || "").toLowerCase();
      const active = document.querySelector(".filter-btn.active")?.dataset.filter || "all";
  
      let visible = 0;
      cards.forEach(card => {
        const text   = (card.dataset.search || "");
        const status = (card.dataset.status || "").toLowerCase();
  
        const ok = (!q || text.includes(q)) && (active === "all" || status === active);
        card.style.display = ok ? "" : "none";
        if (ok) visible++;
      });
  
      // toggle the "No matching orders" placeholder
      if (noResults) noResults.classList.toggle("d-none", visible > 0);
    }
  
    // filter listeners
    searchInput?.addEventListener("input", applyFilters);
    filterBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        filterBtns.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        applyFilters();
      });
    });
  
    // sorting
    sortSelect?.addEventListener("change", () => {
      const val = sortSelect.value;
      const sorted = [...cards].sort((a, b) => {
        const totalA = parseFloat((a.querySelector(".order-total")?.textContent || "").replace(/[^\d.]/g, "")) || 0;
        const totalB = parseFloat((b.querySelector(".order-total")?.textContent || "").replace(/[^\d.]/g, "")) || 0;
        const dateA  = new Date(a.querySelector(".text-muted small")?.textContent || 0);
        const dateB  = new Date(b.querySelector(".text-muted small")?.textContent || 0);
  
        if (val === "total_desc")  return totalB - totalA;
        if (val === "total_asc")   return totalA - totalB;
        if (val === "created_asc") return dateA - dateB;
        return dateB - dateA; // created_desc
      });
  
      if (container) {
        container.innerHTML = "";
        sorted.forEach(el => container.appendChild(el));
      }
    });
  
    // initial render
    applyFilters();
  });
  </script>
  
{% endblock %}
