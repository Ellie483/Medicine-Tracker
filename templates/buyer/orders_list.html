{% extends "base.html" %}
{% block title %}My Orders · Medicine Tracker{% endblock %}

{% block content %}
<div class="container-xxl py-3">

  <!-- Header -->
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
    <div>
      <h2 class="h3 mb-1"><i class="fas fa-cubes me-2 text-success"></i>My Orders</h2>
      <p class="text-muted mb-0">Track and manage your medicine orders</p>
    </div>
  </div>

  <!-- Search + sort -->
  <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
    <div class="flex-grow-1">
      <div class="input-group">
        <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
        <input id="orderSearch" class="form-control" placeholder="Search by pharmacy or medicine name…">
      </div>
    </div>
    <div>
      {# set current sort from query, default newest first #}
{% set sort = request.query_params.get('sort','created_desc') %}

<form id="sortForm" method="get" class="m-0">
  {# preserve other filters in the URL when sorting #}
  <input type="hidden" name="q" value="{{ request.query_params.get('q','') }}">
  <input type="hidden" name="status" value="{{ request.query_params.get('status','') }}">

  <div class="input-group">
    <span class="input-group-text"><i class="fas fa-arrow-up-short-wide"></i></span>
    <select name="sort" id="sortSelect" class="form-select"
            onchange="document.getElementById('sortForm').submit()">
      <option value="created_desc" {{ 'selected' if sort=='created_desc' }}>Newest First</option>
      <option value="created_asc"  {{ 'selected' if sort=='created_asc'  }}>Oldest First</option>
      <option value="total_desc"   {{ 'selected' if sort=='total_desc'   }}>Amount: High → Low</option>
      <option value="total_asc"    {{ 'selected' if sort=='total_asc'    }}>Amount: Low → High</option>
    </select>
  </div>
</form>

    </div>
  </div>

  <!-- Filter chips -->
  <div class="d-flex flex-wrap gap-2 mb-3" id="statusFilters">
    <button class="btn btn-sm btn-success filter-btn active" data-filter="all">All Orders ({{ orders|length }})</button>
    <button class="btn btn-sm btn-light filter-btn" data-filter="delivered">Delivered</button>
    <button class="btn btn-sm btn-light filter-btn" data-filter="confirmed">Confirmed</button>
    <button class="btn btn-sm btn-light filter-btn" data-filter="pending">Pending</button>
    <button class="btn btn-sm btn-light filter-btn" data-filter="cart">Cart</button>
  </div>

  {% if orders and orders|length > 0 %}
    <div class="row g-3" id="ordersContainer">
      {% for order in orders %}
        {% set items = order.get('items', []) %}
        {% set item_count = items|length %}
        {% set first_name = items[0]['medicine_name'] if item_count else '—' %}
        {% set qty_total = items|map(attribute='quantity')|sum if item_count else 0 %}

        <div class="col-12 col-lg-6 col-xl-4 order-card-wrapper"
             data-status="{{ order.order_status|lower }}"
             data-search="{{ (order.pharmacy_name ~ ' ' ~ (items|map(attribute='medicine_name')|join(' ')))|lower }}">
          <article class="card border-0 shadow-sm order-card h-100">
            <div class="card-body d-flex flex-column gap-3">

              <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                  <i class="fas fa-calendar me-1"></i>{{ order.created_at_str or order.created_at or '—' }}
                </div>
                <span class="small">Order #{{ order._id }}</span>
              </div>

              <div class="d-flex flex-wrap gap-2">
                <span class="badge bg-light text-dark">{{ order.order_status|title }}</span>
                <span class="badge bg-light text-dark">{{ order.payment_status|title }}</span>
              </div>

              <div class="fw-semibold text-success fs-5">{{ order.formatted_total }}</div>

              <div class="bg-light rounded-3 px-3 py-2 d-flex align-items-center">
                <i class="fas fa-building-columns me-2 text-muted"></i>
                <span class="fw-semibold">{{ order.pharmacy_name or '—' }}</span>
              </div>

              <div class="small">
                <i class="fas fa-box me-1 text-muted"></i>
                {% if item_count == 0 %}No items
                {% elif item_count == 1 %}
                  {{ first_name }} · Qty {{ qty_total }}
                {% else %}
                  {{ first_name }} · Qty {{ qty_total }} <span class="text-muted">+{{ item_count - 1 }} more</span>
                {% endif %}
              </div>

              <div class="mt-auto">
                <a class="btn btn-outline-secondary w-100" href="/buyer/orders/{{ order._id }}">
                  <i class="fas fa-eye me-1"></i>View Details
                </a>
              </div>

            </div>
          </article>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-5">
      <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
      <h3 class="fw-semibold mb-1">No orders yet</h3>
      <p class="text-muted mb-4">Start browsing medicines to place your first order.</p>
      <a href="/buyer/medicines" class="btn btn-primary"><i class="fas fa-pills me-2"></i>Browse Medicines</a>
    </div>
  {% endif %}
</div>

<style>
.order-card { border-radius: 1rem; transition: transform .18s ease, box-shadow .18s ease; }
.order-card:hover { transform: translateY(-2px); box-shadow: 0 .6rem 1.2rem rgba(0,0,0,.07); }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.getElementById("orderSearch");
  const sortSelect = document.getElementById("sortSelect");
  const filterBtns = document.querySelectorAll(".filter-btn");
  const orders = [...document.querySelectorAll(".order-card-wrapper")];

  function applyFilters() {
    const q = searchInput.value.toLowerCase();
    const status = document.querySelector(".filter-btn.active").dataset.filter;

    orders.forEach(o => {
      const text = o.dataset.search;
      const orderStatus = o.dataset.status;
      const matchSearch = !q || text.includes(q);
      const matchStatus = status === "all" || status === orderStatus;
      o.style.display = (matchSearch && matchStatus) ? "" : "none";
    });
  }

  searchInput.addEventListener("input", applyFilters);
  filterBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      filterBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      applyFilters();
    });
  });

  // sort
  sortSelect.addEventListener("change", () => {
    const val = sortSelect.value;
    const container = document.getElementById("ordersContainer");
    const sorted = [...orders].sort((a, b) => {
      const totalA = parseFloat(a.querySelector(".fs-5").innerText.replace(/[^\d.]/g, "")) || 0;
      const totalB = parseFloat(b.querySelector(".fs-5").innerText.replace(/[^\d.]/g, "")) || 0;
      const dateA = new Date(a.querySelector(".text-muted small").innerText);
      const dateB = new Date(b.querySelector(".text-muted small").innerText);

      if (val === "total_desc") return totalB - totalA;
      if (val === "total_asc") return totalA - totalB;
      if (val === "created_asc") return dateA - dateB;
      return dateB - dateA; // created_desc
    });
    container.innerHTML = "";
    sorted.forEach(el => container.appendChild(el));
  });

  applyFilters();
});
</script>
{% endblock %}
