{% extends "base.html" %}
{% block title %}My Orders - Medicine Tracker{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="fas fa-shopping-cart me-2 text-success"></i>My Orders</h2>
                    <p class="text-muted mb-0">Track your medicine orders and payment status</p>
                </div>
                <div>
                    <span class="badge bg-success fs-6">{{ orders|length }} Total Orders</span>
                </div>
            </div>
        </div>
    </div>
    {% if orders %}
    <div class="row">
        {% for item in order["items"] %}
        <div class="col-12 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-1">
                                <i class="fas fa-receipt me-2 text-primary"></i>
                                Order #{{ order._id|string|truncate(8, true, '...') }}
                            </h5>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>
                                {{ order.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                            </small>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <div class="mb-2">
                                {% if order.status == 'confirmed' %}
                                <span class="badge bg-success fs-6">
                                    <i class="fas fa-check me-1"></i>Confirmed
                                </span>
                                {% elif order.status == 'pending' %}
                                <span class="badge bg-warning fs-6">
                                    <i class="fas fa-clock me-1"></i>Pending
                                </span>
                                {% elif order.status == 'delivered' %}
                                <span class="badge bg-info fs-6">
                                    <i class="fas fa-truck me-1"></i>Delivered
                                </span>
                                {% else %}
                                <span class="badge bg-secondary fs-6">{{ order.status|title }}</span>
                                {% endif %}
                            </div>
                            <div class="fw-bold text-success fs-5">{{ order.formatted_total }}</div>
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="mb-3">
                                <i class="fas fa-pills me-2 text-primary"></i>Order Items
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Medicine</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in order["items"] %}
                                        <tr>
                                            <td>{{ item.medicine_name }}</td>
                                            <td>{{ item.quantity }}</td>
                                            <td>₹{{ "%.2f"|format(item.price) }}</td>
                                            <td>₹{{ "%.2f"|format(item.quantity * item.price) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <h6 class="mb-3">
                                <i class="fas fa-store me-2 text-info"></i>Pharmacy Details
                            </h6>
                            <div class="mb-3">
                                <strong>{{ order.pharmacy_name }}</strong>
                            </div>
                            
                            <h6 class="mb-3">
                                <i class="fas fa-credit-card me-2 text-warning"></i>Payment Status
                            </h6>
                            <div class="mb-3">
                                {% if order.payment_status == 'paid' %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check me-1"></i>Paid
                                </span>
                                {% else %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-clock me-1"></i>Pending Payment
                                </span>
                                {% endif %}
                            </div>
                            
                            <div class="d-grid gap-2">
                                {% if order.payment_status != 'paid' %}
                                <a href="/buyer/checkout/{{ order._id }}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-credit-card me-1"></i>Pay Now
                                </a>
                                {% endif %}
                                
                                {% if order.qr_code_path %}
                                <button class="btn btn-outline-info btn-sm" onclick="showQR('{{ order._id }}')">
                                    <i class="fas fa-qrcode me-1"></i>Show QR Code
                                </button>
                                {% endif %}
                                
                                {% if order.receipt_path %}
                                <a href="/static/receipts/{{ order.receipt_path }}" target="_blank" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-download me-1"></i>Download Receipt
                                </a>
                                {% else %}
                                <button class="btn btn-outline-secondary btn-sm" onclick="uploadReceipt('{{ order._id }}')">
                                    <i class="fas fa-upload me-1"></i>Upload Receipt
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-shopping-cart fa-4x text-muted mb-4"></i>
                <h3 class="text-muted mb-3">No orders yet</h3>
                <p class="text-muted mb-4">Start browsing medicines to place your first order</p>
                <a href="/buyer/medicines" class="btn btn-primary">
                    <i class="fas fa-pills me-2"></i>Browse Medicines
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
<script>
function showQR(orderId) {
    document.getElementById('qrImage').src = `/static/qr_codes/order_${orderId}.png`;
    new bootstrap.Modal(document.getElementById('qrModal')).show();
}
function uploadReceipt(orderId) {
    document.getElementById('receiptOrderId').value = orderId;
    new bootstrap.Modal(document.getElementById('receiptModal')).show();
}
// Handle receipt upload
document.getElementById('receiptForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/upload_receipt', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                bootstrap.Modal.getInstance(document.getElementById('receiptModal')).hide();
                location.reload(); // Refresh to show updated status
            } else {
                alert('Error: ' + result.message);
            }
        } else {
            alert('Failed to upload receipt. Please try again.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    }
});
</script>
<style>
.card {
    transition: transform 0.2s ease-in-out;
}
.card:hover {
    transform: translateY(-2px);
}
.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}
.badge {
    font-size: 0.8em;
}
</style>
{% endblock %}